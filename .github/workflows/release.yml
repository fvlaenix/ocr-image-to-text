name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Explicit tag (vX.Y.Z). Leave empty to auto-bump."
        required: false
        type: string
      bump:
        description: "Version bump type when tag is empty."
        required: false
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.compute_tag.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Compute and push tag
        id: compute_tag
        shell: bash
        run: |
          set -euo pipefail

          tag_input="${{ inputs.tag }}"
          bump="${{ inputs.bump }}"
          tag_pattern='^v[0-9]+\.[0-9]+\.[0-9]+$'

          git fetch --tags --force
          last_tag="$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' | sort -V | tail -n1 || true)"

          new_tag=""

          if [[ -n "${tag_input}" ]]; then
            if [[ ! "${tag_input}" =~ ${tag_pattern} ]]; then
              echo "Tag must match vX.Y.Z"
              exit 1
            fi

            # QoL: если ввели тот же тег — считаем как "пусто" и делаем bump
            if [[ "${tag_input}" != "${last_tag}" ]]; then
              new_tag="${tag_input}"
            fi
          fi

          if [[ -z "${new_tag}" ]]; then
            if [[ -z "${last_tag}" ]]; then
              new_tag="v1.0.0"
            else
              base="${last_tag#v}"
              IFS=. read -r major minor patch <<< "${base}"
              case "${bump}" in
                major)
                  major=$((major + 1)); minor=0; patch=0
                  ;;
                minor)
                  minor=$((minor + 1)); patch=0
                  ;;
                patch)
                  patch=$((patch + 1))
                  ;;
                *)
                  echo "Unknown bump type: ${bump}"
                  exit 1
                  ;;
              esac
              new_tag="v${major}.${minor}.${patch}"
            fi
          fi

          if git tag -l "${new_tag}" | grep -q .; then
            echo "Tag ${new_tag} already exists"
            exit 1
          fi

          git tag "${new_tag}"
          git push origin "${new_tag}"

          echo "Created tag ${new_tag}"
          echo "tag=${new_tag}" >> "$GITHUB_OUTPUT"

  publish:
    runs-on: ubuntu-latest
    needs: tag
    permissions:
      contents: read

    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.tag.outputs.tag }}
          submodules: true

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Publish to Nexus
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ needs.tag.outputs.tag }}"
          VERSION="${TAG#v}"
          ./gradlew publish -PreleaseVersion="${VERSION}" --no-configuration-cache
